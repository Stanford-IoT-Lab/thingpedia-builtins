// -*- mode: js; indent-tabs-mode: nil; js-basic-offset: 4 -*-
//
// This file is part of ThingEngine
//
// Copyright 2015 Giovanni Campagna <gcampagn@cs.stanford.edu>
//
// See COPYING for details

const lang = require('lang');
const Q = require('q');
const Tp = require('thingpedia');

const OmletUser = new lang.Class({
    Name: 'OmletUser',
    Extends: Tp.Messaging.User,

    _init: function(id, o) {
        this.id = id;
        this.account = o.account;
        this.name = o.name;
    }
});

function oinvoke(object, method) {
    var args = Array.prototype.slice.call(arguments, 2);

    return Q.Promise(function(callback, errback) {
        args.push(callback);
        return object[method].apply(object, args);
    });
}

function arrayEqual(a, b) {
    if (a.length !== b.length)
        return false;
    for (var i = 0; i < a.length; i++)
        if (a[i] !== b[i])
            return false;
    return true;
}

const OmletFeed = new lang.Class({
    Name: 'OmletFeed',
    Extends: Tp.Messaging.Feed,

    _init: function(messaging, feedId) {
        this.parent(feedId);
        this._messaging = messaging;
        this._device = messaging._device;
        this._client = null;
        this._insertListener = null;
        this._db = null;
        this.ownId = null;

        this._lastMessage = 0;
        this._memberList = [];
        this._members = [];
        this.name = null;
    },

    _onInsert: function(o) {
        if (o.serverTimestamp < this._lastMessage)
            return;
        this._lastMessage = o.serverTimestamp;
        this.emit('new-message', o);
        if (this.ownId !== o.senderId)
            this.emit('incoming-message', o);
        else
            this.emit('outgoing-message', o);
    },

    _updateMembers: function() {
        if (arrayEqual(this._memberList, this._feed.members))
            return Q();
        this._memberList = this._feed.members.slice();

        var sortedList = new Array(this._memberList.length);
        for (var i = 0, j = 0; i < this._memberList.length; i++) {
            var id = this._memberList[i];
            if (id === this.ownId) {
                sortedList[0] = id;
            } else {
                sortedList[j+1] = id;
                j++;
            }
        }
        return Q.all(sortedList.map(function(m) {
            return this._messaging.getUserById(m);
        }, this)).then(function(users) {
            this._members = users;

            console.log('New feed members', users.map(function(u) { return u.name; }));
        }.bind(this));
    },

    _updateName: function() {
        if (this._feed.name) {
            this.name = this._feed.name;
        } else if (this._memberList.every(function(m) { return m === this.ownId; }, this)) {
            this.name = "You";
        } else {
            this.name = this._members[1].name;
        }
    },

    update: function(feed) {
        this._feed = feed;

        this._updateMembers().then(function() {
            this._updateName();
            this.emit('changed');
        }.bind(this)).done();
    },

    _doOpen: function() {
        console.log('Opening feed with ID ' + this.feedId);

        this._client = this._device.refOmletClient();

        return this._messaging.getOwnId().then(function(ownId) {
            this.ownId = ownId;
            return this._getFeed();
        }.bind(this)).then(function(o) {
            this._feed = o;
            return this._updateMembers();
        }.bind(this)).then(function() {
            this._updateName();
            return oinvoke(this._client.store, 'getFeedObjects', this._client.store.getObjectId(this._feed));
        }.bind(this)).then(function(db) {
            this._db = db;
            this._insertListener = this._onInsert.bind(this);
            this._db._data.on('insert', this._insertListener);
        }.bind(this));
    },

    _doClose: function() {
        this._device.unrefOmletClient();
        this._client = null;

        if (this._insertListener)
            this._db._data.removeListener('insert', this._insertListener);
        this._insertListener = null;
        this._messaging.feedClosed(this.feedId);

        return Q();
    },

    _getFeed: function() {
        return oinvoke(this._client.store, 'getFeeds').then(function(db) {
            return oinvoke(db, 'getObjectByKey', this.feedId);
        }.bind(this)).then(function(o) {
            return o;
        }.bind(this));
    },

    getMembers: function() {
        return this._members;
    },

    sendText: function(text) {
        return Q.ninvoke(this._client.messaging, '_sendObjToFeed', this._feed, 'text',
                         { text: text });
    },

    sendPicture: function(url) {
        if (typeof url === 'string') {
            if (url.startsWith('http')) {
                return Tp.Helpers.Http.get(url, { raw: true }).spread(function(data, contentType) {
                    return Q.ninvoke(this._client.messaging, '_pictureObjFromBytes', data, contentType);
                }.bind(this)).spread(function(objType, obj) {
                    return Q.ninvoke(this._client.messaging, '_sendObjToFeed',
                                     this._feed, objType, obj);
                }.bind(this));
            } else {
                throw new Error('Sending pictures by non-http url is not implemented, sorry');
            }
        } else if (Buffer.isBuffer(url)) {
            return Q.ninvoke(this._client.messaging, '_pictureObjFromBytes', url)
                .spread(function(objType, obj) {
                    return Q.ninvoke(this._client.messaging, '_sendObjToFeed',
                                     this._feed, objType, obj);
                }.bind(this));
        } else {
            throw new TypeError('Invalid type for call to sendPicture, must be string or buffer');
        }
    },

    sendItem: function(item) {
        var silent = true;
        return Q.ninvoke(this._client.messaging, '_sendObjToFeed', this._feed, 'text',
                         { text: JSON.stringify(item), silent: silent,
                           hidden: silent });
    },

    sendRaw: function(rawItem) {
        return Q.ninvoke(this._client.messaging, '_sendObjToFeed', this._feed, rawItem.type,
                         rawItem);
    }
});

module.exports = new lang.Class({
    Name: 'OmletMessaging',
    Extends: Tp.Messaging,
    $rpcMethods: ['get isAvailable', 'getOwnId', 'getUserById', 'getAccountById',
                  'getFeedMetas', 'getFeedMeta'],

    _init: function(device) {
        this._device = device;

        this._feeds = {};
        this._syncclient = null;
    },

    _onFeedRemoved: function(o) {
        delete this._feeds[o.identifier];
    },

    _onFeedChanged: function(o) {
        var feed = this._feeds[o.identifier];
        if (feed)
            feed.update(o);
    },

    feedClosed: function(identifier) {
        delete this._feeds[identifier];
    },

    getFeed: function(feedId) {
        if (feedId in this._feeds)
            return this._feeds[feedId];

        return this._feeds[feedId] = new OmletFeed(this, feedId);
    },

    startSync: function() {
        this._syncclient = this._device.refOmletClient();
        this._syncclient.longdanMessageConsumer.start();

        oinvoke(this._syncclient.store, 'getFeeds').then(function(db) {
            this._feedRemovedListener = this._onFeedRemoved.bind(this);
            this._feedChangedListener = this._onFeedChanged.bind(this);
            db._data.on('delete', this._feedRemovedListener);
            db._data.on('update', this._feedChangedListener);
        }.bind(this)).done();
    },

    stopSync: function() {
        oinvoke(this._syncclient.store, 'getFeeds').then(function(db) {
            db._data.removeListener('delete', this._feedRemovedListener);
            db._data.removeListener('update', this._feedChangedListener);
        }.bind(this)).done();

        this._device.unrefOmletClient();
        this._syncclient = null;
    },

    getOwnId: function() {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getAccounts').then(function(db) {
            return db._data.find({ owned: true }).map(function(o) {
                return client.store.getObjectId(o);
            })[0];
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getUserById: function(id) {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getAccounts').then(function(db) {
            return oinvoke(db, 'getObjectById', id).then(function(o) {
                return new OmletUser(client.store.getObjectId(o), o);
            });
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getAccountById: function(id) {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getAccounts').then(function(db) {
            return oinvoke(db, 'getObjectById', id).then(function(o) {
                return o.account;
            });
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getAccountNameById: function(id) {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getAccounts').then(function(db) {
            return oinvoke(db, 'getObjectById', id).then(function(o) {
                return o.name;
            });
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getFeedList: function() {
        return this.getFeedMetas().then(function(data) {
            return data.map(function(d) {
                return d.identifier;
            });
        });
    },

    getFeedMetas: function() {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getFeeds').then(function(db) {
            return db._data.find().filter(function(f) {
                return f.members.length > 0 &&
                    f.acceptance !== 'Removed';
            });
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getFeedMeta: function(feedId) {
        var client = this._device.refOmletClient();
        return oinvoke(client.store, 'getFeeds').then(function(db) {
            return oinvoke(db, 'getObjectByKey', feedId);
        }).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    createFeed: function() {
        var client = this._device.refOmletClient();
        return Q.ninvoke(client.feed, 'createFeed').then(function(feed) {
            return new OmletFeed(this, feed.identifier);
        }.bind(this)).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },

    getFeedWithContact: function(contactId) {
        console.log('OmletMessaging.getFeedWithContact');

        var client = this._device.refOmletClient();
        return Q.ninvoke(client.feed, 'getOrCreateFeedWithMembers', [contactId]).then(function(result) {
            console.log('result', result)
            return this.getFeed(result[0].identifier);
        }.bind(this)).finally(function() {
            this._device.unrefOmletClient();
        }.bind(this));
    },
});
